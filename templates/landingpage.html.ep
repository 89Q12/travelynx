% if (is_user_authenticated()) {
	% if (stash('error')) {
		<div class="row">
			<div class="col s12">
				<div class="card red darken-4">
					<div class="card-content white-text">
						<span class="card-title">Backend-Fehler</span>
						<p><%= stash('error') %></p>
					</div>
				</div>
			</div>
		</div>
	% }
	<div class="row">
		<div class="col s12">
			% my $status = get_user_status();
			% my $now = DateTime->now(time_zone => 'Europe/Berlin');
			% my $dep_wait = ($status->{real_departure}->epoch - $now->epoch)/60;
			% my $arr_wait = undef;
			% if ($status->{real_arrival}->epoch) {
				% $arr_wait = ($status->{real_arrival}->epoch - $now->epoch)/60;
			% }
			% if ($status->{checked_in}) {
				<div class="card green darken-4">
					<div class="card-content white-text">
						<span class="card-title">Eingecheckt</span>
						<p>
							In <b><%= $status->{train_type} %> <%= $status->{train_no} %></b>
							% if ($status->{arr_name}) {
								von <b><%= $status->{dep_name} %></b> nach <b><%= $status->{arr_name} %></b>.
							% }
							% else {
								ab <b><%= $status->{dep_name} %></b>.
							% }
						</p>
						<p>
							Abfahrt
							% if ($dep_wait > 0) {
								in <%= int(($status->{real_departure}->epoch - $now->epoch)/60) %> Minute<%= $dep_wait == 1 ? '' : 'n' %>
							% }
							um <b><%= $status->{real_departure}->strftime('%H:%M') %></b>
							% if ($status->{real_departure}->epoch != $status->{sched_departure}->epoch) {
								(+<%= int(($status->{real_departure}->epoch - $status->{sched_departure}->epoch)/60) %>)
							% }
						</p>
						<p>
							% if ($status->{real_arrival}->epoch) {
								Voraussichtliche Ankunft um <b><%= $status->{real_arrival}->strftime('%H:%M') %></b>
								% if ($status->{real_arrival}->epoch != $status->{sched_arrival}->epoch) {
									(+<%= int(($status->{real_arrival}->epoch - $status->{sched_arrival}->epoch)/60) %>)
								% }
							% }
							% else {
								Ankunft: noch nicht bekannt
							% }
						</p>
						<p>
							<b>Achtung:</b> Automatischer Checkout ist noch nicht
							implementiert. Bitte spätestens eine Stunde nach Ankunft
							am Ziel manuell auschecken.
						</p>
						% if ($status->{arr_name}) {
							<p>Zielstation ändern?</p>
						% }
						% else {
							<p>Zielstation wählen:</p>
						% }
						<table>
							<tbody>
								% my $is_after = 0;
								% for my $station (@{$status->{route_after}}) {
									% if ($status->{arr_name} and $station eq $status->{arr_name}) {
										<tr><td><b><a class="action-checkout" data-station="<%= $station %>"><%= $station %></a></b></td></tr>
									% }
									% else {
										<tr><td><a class="action-checkout" data-station="<%= $station %>"><%= $station %></a></td></tr>
									% }
								% }
							</tbody>
						</table>
						% if ($status->{arr_name}) {
							<p>
								Falls das Backend ausgefallen ist oder der Zug aus anderen
								Gründen verloren ging: <a class="action-checkout"
								data-force="1" data-station="<%= $status->{arr_name}
								%>">Ohne Echtzeitdaten in <%= $status->{arr_name} %>
								auschecken</a>.
							</p>
						% }
					</div>
					<div class="card-action">
						<a class="action-undo" data-id="in_transit">
							<i class="material-icons">undo</i> Checkin Rückgängig?
						</a>
					</div>
				</div>
			% }
			% elsif ($status->{cancelled}) {
				<div class="card yellow lighten-4">
					<div class="card-content">
						<span class="card-title">Zugausfall dokumentieren</span>
						<p>Prinzipiell wärest du nun eingecheckt in
							<%= $status->{train_type} %> <%= $status->{train_no} %>
							ab <%= $status->{station_name} %>, doch dieser Zug fällt aus.
							</p>
						<p>Falls du den Zugausfall z.B. für ein Fahrgastrechteformular
							dokumentieren möchtest, wähle bitte jetzt deine geplante
							Zielstation aus. Achtung: Momentan wird dabei keine
							Soll-Ankunftszeit gespeichert, das zu beheben steht auf
							der Todoliste.</p>
						<table>
							<tbody>
								% my $is_after = 0;
								% for my $station (@{$status->{route_after}}) {
									<tr><td><a class="action-cancelled-to" data-station="<%= $station %>"><%= $station %></a></td></tr>
								% }
							</tbody>
						</table>
					</div>
					<div class="card-action">
						<a class="action-undo" data-id="in_transit">
							<i class="material-icons">undo</i> Checkinversuch Rückgängig?
						</a>
					</div>
				</div>
			% }
			% else {
				<div class="card grey darken-4">
					<div class="card-content white-text">
						<span class="card-title">Hallo, <%= current_user()->{name} %>!</span>
						<p>Du bist gerade nicht eingecheckt.</p>
						<p class="geolocationhint">Stationen in der Umgebung:</p>
						<div class="geolocation">
							<div class="progress"><div class="indeterminate"></div></div>
						</div>
						%= form_for 'list_departures' => begin
							<div class="input-field">
								%= text_field 'station', id => 'station', class => 'autocomplete white-text', required => undef
								<label for="station">Manuelle Eingabe (Name oder DS100)</label>
							</div>
							<div class="center-align">
								<button class="btn waves-effect waves-light btn-flat white" type="submit" name="action" value="departures">
									<i class="material-icons left">send</i>
									Abfahrten
								</button>
							</div>
						%= end
					</div>
				</div>
			% }
		</div>
	</div>
	<h1>Letzte Fahrten</h1>
	%= include '_history_trains', journeys => [get_user_travels(limit => 5)];
% }
% else {
	<div class="row">
		<div class="col s12">
			<p>
				Travelynx erlaubt das Einchecken in Züge im Netz der Deutschen
				Bahn. So können die eigenen Fahrten später inklusive Echtzeitdaten
				und eingetragenen Servicemeldungen nachvollzogen und brennende
				Fragen wie „Wie viele Stunden habe ich letzten Monat im Zug
				vebracht?“ beantwortet werden.
			</p>
			<p>
				Die Idee dazu kommt von <a
				href="https://traewelling.de/">Träwelling</a>, hier gibt es aber
				keine Twitter-Anbindung und keine öffentlichen Leaderboards.
			</p>
			<p>
				Features:
				<ul>
					<li>Protokoll von Fahrplan- und Echtzeitdaten an Start- und
						Zielbahnhof</li>
					<li>API zum automatisierten Auslesen des aktuellen Status</li>
					<li>Statistiken über Reisezeiten und Verspätungen</li>
				</ul>
			</p>
			<p>
				Travelynx ist ein kostenfreies, privat betriebenes Projekt ohne
				Verfügbarkeitsgarantie. Unangekündigte Downtimes oder eine
				kurzfristige Einstellung dieser Seite sind nicht vorgesehen, aber
				möglich. Wer mag, kann auch den
				<a href="https://finalrewind.org/projects/travelynx">Quelltext</a>
				laden und eine eigene Instanz aufsetzen.
			</p>
		</div>
	</div>
	<div class="row">
		<div class="col s1 m1 l3">
		</div>
		<div class="col s10 m10 l6 center-align">
			<a href="/register" class="waves-effect waves-light btn"><i class="material-icons left">add</i>Registrieren</a>
			<a href="/login" class="waves-effect waves-light btn"><i class="material-icons left">account_circle</i>Anmelden</a>
		</div>
		<div class="col s1 m1 l3">
		</div>
	</div>
% }
